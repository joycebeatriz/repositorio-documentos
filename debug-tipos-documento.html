<!DOCTYPE html>
<html>
<head>
    <title>Debug - Tipos de Documento</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .resultado { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .sucesso { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .erro { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; max-height: 300px; }
        .debug { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .debug h3 { margin-top: 0; color: #856404; }
        .debug ul { margin: 10px 0; }
        .debug li { margin: 5px 0; }
    </style>
</head>
<body>
    <h1>üîç Debug - Tipos de Documento</h1>
    
    <div id="status" class="resultado info">
        Debugando tipos de documento...
    </div>
    
    <div class="debug">
        <h3>üîç Problema Identificado:</h3>
        <ul>
            <li><strong>Legenda ainda mostra nomes completos</strong> em vez de siglas</li>
            <li><strong>Poss√≠vel causa:</strong> Dados n√£o est√£o sendo mapeados corretamente</li>
            <li><strong>Solu√ß√£o:</strong> Verificar se TYPE_META est√° sendo usado</li>
        </ul>
    </div>
    
    <div>
        <button onclick="debugTipos()">Debug Tipos</button>
        <button onclick="verificarStats()">Verificar Stats</button>
        <button onclick="verificarDocuments()">Verificar Documents</button>
    </div>
    
    <div id="resultado"></div>

    <script>
        function mostrarStatus(mensagem, tipo = 'info') {
            const status = document.getElementById('status');
            status.textContent = mensagem;
            status.className = `resultado ${tipo}`;
        }
        
        function mostrarResultado(titulo, dados) {
            const resultado = document.getElementById('resultado');
            resultado.innerHTML = `
                <h3>${titulo}</h3>
                <pre>${JSON.stringify(dados, null, 2)}</pre>
            `;
        }
        
        async function debugTipos() {
            mostrarStatus('Debugando tipos de documento...', 'info');
            
            try {
                // Verificar estat√≠sticas
                const statsResponse = await fetch('http://localhost:3001/api/stats');
                const statsData = await statsResponse.json();
                
                // Verificar documentos
                const docsResponse = await fetch('http://localhost:3001/api/documents');
                const docsData = await docsResponse.json();
                
                mostrarStatus('‚úÖ Debug realizado', 'sucesso');
                mostrarResultado('üîç Debug Completo', {
                    estatisticas: {
                        disponivel: !!statsData.success,
                        tipos: statsData.success ? Object.keys(statsData.data.statistics.byType) : 'N/A',
                        exemplo: statsData.success ? Object.entries(statsData.data.statistics.byType).slice(0, 3) : 'N/A'
                    },
                    documentos: {
                        disponivel: !!docsData.success,
                        total: docsData.success ? docsData.count : 'N/A',
                        exemplo: docsData.success ? docsData.data.slice(0, 2).map(d => ({ tipo: d.tipo, tipoSigla: d.tipoSigla })) : 'N/A'
                    },
                    TYPE_META: {
                        CV: { label: 'CV', displayName: 'Cadeia de Valor', color: '#6ee7b7' },
                        MAN: { label: 'MAN', displayName: 'Manual', color: '#fbbf24' },
                        MOD: { label: 'MOD', displayName: 'Modelagem de Processos', color: '#c4b5fd' },
                        POP: { label: 'POP', displayName: 'Procedimento Operacional Padr√£o', color: '#60a5fa' },
                        IT: { label: 'IT', displayName: 'Instru√ß√£o de Trabalho', color: '#f87171' },
                        VID: { label: 'VID', displayName: 'V√≠deo', color: '#c084fc' },
                        CAT: { label: 'CAT', displayName: 'Cat√°logo de Servi√ßos', color: '#fb923c' }
                    }
                });
            } catch (error) {
                mostrarStatus(`‚ùå Erro: ${error.message}`, 'erro');
            }
        }
        
        async function verificarStats() {
            mostrarStatus('Verificando estat√≠sticas...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/api/stats');
                const data = await response.json();
                
                if (data.success) {
                    mostrarStatus('‚úÖ Estat√≠sticas carregadas', 'sucesso');
                    mostrarResultado('üìä Estat√≠sticas de Tipos', {
                        tipos: Object.entries(data.data.statistics.byType),
                        total: Object.keys(data.data.statistics.byType).length
                    });
                } else {
                    mostrarStatus('‚ùå Erro ao carregar estat√≠sticas', 'erro');
                }
            } catch (error) {
                mostrarStatus(`‚ùå Erro: ${error.message}`, 'erro');
            }
        }
        
        async function verificarDocuments() {
            mostrarStatus('Verificando documentos...', 'info');
            
            try {
                const response = await fetch('http://localhost:3001/api/documents');
                const data = await response.json();
                
                if (data.success) {
                    // Analisar tipos nos documentos
                    const tiposEncontrados = {};
                    data.data.forEach(doc => {
                        const tipo = doc.tipo || doc.tipoSigla || 'N/A';
                        tiposEncontrados[tipo] = (tiposEncontrados[tipo] || 0) + 1;
                    });
                    
                    mostrarStatus('‚úÖ Documentos carregados', 'sucesso');
                    mostrarResultado('üìÑ Tipos nos Documentos', {
                        totalDocumentos: data.count,
                        tiposEncontrados: Object.entries(tiposEncontrados),
                        exemplo: data.data.slice(0, 3).map(d => ({ 
                            tipo: d.tipo, 
                            tipoSigla: d.tipoSigla,
                            titulo: d.titulo?.substring(0, 30) + '...'
                        }))
                    });
                } else {
                    mostrarStatus('‚ùå Erro ao carregar documentos', 'erro');
                }
            } catch (error) {
                mostrarStatus(`‚ùå Erro: ${error.message}`, 'erro');
            }
        }
        
        // Teste autom√°tico ao carregar
        window.onload = () => {
            mostrarStatus('P√°gina carregada. Testando conex√£o...', 'info');
            setTimeout(async () => {
                try {
                    const response = await fetch('http://localhost:3001/api/test');
                    const data = await response.json();
                    mostrarStatus('‚úÖ Conectado ao backend. Pronto para debug!', 'sucesso');
                } catch (error) {
                    mostrarStatus(`‚ùå Erro de conex√£o: ${error.message}`, 'erro');
                }
            }, 1000);
        };
    </script>
</body>
</html>
